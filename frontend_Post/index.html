<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Screen with Images</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 0;
            background-color: #f4f4f4;
        }

        .product-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fff;
            margin-bottom: 20px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: flex-start;
        }

        .product-card img {
            max-width: 150px;
            max-height: 150px;
            border-radius: 8px;
            margin-right: 20px;
        }

        .product-card h2 {
            margin: 0 0 10px 0;
            font-size: 24px;
            color: #333;
        }

        .product-card p {
            margin: 5px 0;
            color: #555;
        }

        .product-card .price {
            font-size: 18px;
            font-weight: bold;
            color: #27ae60;
        }

        .product-card .attributes {
            margin-top: 10px;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
        }

        .product-card .attributes p {
            margin: 5px 0;
            color: #444;
        }

        /* Form Styles */
        .form-container, .upload-form-container {
            margin-top: 30px;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .form-container input,
        .form-container textarea,
        .upload-form-container input,
        .upload-form-container select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .form-container button,
        .upload-form-container button {
            background-color: #27ae60;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .form-container button:hover,
        .upload-form-container button:hover {
            background-color: #2ecc71;
        }
    </style>
</head>
<body>
    <h1>Product List with Images</h1>
    <div id="productList"></div>

    <div class="form-container">
        <h2>Create New Product</h2>
        <form id="createProductForm">
            <input type="text" id="productName" placeholder="Product Name" required />
            <textarea id="productDescription" placeholder="Product Description" required></textarea>
            <input type="number" id="productPrice" placeholder="Product Price (in UZS)" required />
            <input type="number" id="productStock" placeholder="Stock Quantity" required />
            <button type="submit">Create Product</button>
        </form>
    </div>

    <div class="upload-form-container">
        <h2>Upload Product Image</h2>
        <form id="uploadForm" enctype="multipart/form-data">
            <label for="product_id">Product ID:</label>
            <input type="number" id="product_id" name="product_id" placeholder="Enter product ID" required>

            <label for="is_primary">Is Primary Image:</label>
            <select id="is_primary" name="is_primary" required>
                <option value="true">Yes</option>
                <option value="false">No</option>
            </select>

            <label for="image">Choose Image:</label>
            <input type="file" id="image" name="image" accept="image/*" required>

            <button type="submit">Upload</button>
        </form>
    </div>

    <script>
        const productsUrl = "62.171.149.94/products";
        const attributesUrl = "62.171.149.94/attributes";
        const productAttributesUrl = "62.171.149.94/productattributes";
        const productImagesUrl = "62.171.149.94/productimages";
        const createProductUrl = "http://62.171.149.94:8000/createproduct"; // New POST URL for creating a product
        const uploadImageUrl = "http://62.171.149.94:8000/createproductimage"; // New POST URL for uploading image

        async function fetchProducts() {
            try {
                const productsResponse = await fetch(productsUrl);
                const productsData = await productsResponse.json();

                const attributesResponse = await fetch(attributesUrl);
                const attributesData = await attributesResponse.json();

                const productAttributesResponse = await fetch(productAttributesUrl);
                const productAttributesData = await productAttributesResponse.json();

                const productImagesResponse = await fetch(productImagesUrl);
                const productImagesData = await productImagesResponse.json();

                displayProducts(
                    productsData.products,
                    attributesData.attributes,
                    productAttributesData.product_attributes,
                    productImagesData.product_image
                );
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        function displayProducts(products, attributes, productAttributes, productImages) {
            const productList = document.getElementById("productList");
            productList.innerHTML = ""; // Clear the current list before adding new products

            products.forEach(product => {
                const productCard = document.createElement("div");
                productCard.className = "product-card";

                const primaryImage = productImages.find(
                    img => img.product_id === product.id && img.is_primary
                );
                const imageUrl = primaryImage
                    ? `http://62.171.149.94:8000/${primaryImage.image_url}`
                    : "https://via.placeholder.com/150";

                productCard.innerHTML = `
                    <img src="${imageUrl}" alt="${product.name}">
                    <div>
                        <h2>${product.name}</h2>
                        <p>${product.description}</p>
                        <p class="price">Price: ${product.price} UZS</p>
                        <p>Stock: ${product.stock_quantity}</p>
                        <div class="attributes">
                            <h3>Attributes:</h3>
                            ${getProductAttributes(product.id, attributes, productAttributes)}
                        </div>
                    </div>
                `;

                productList.appendChild(productCard);
            });
        }

        function getProductAttributes(productId, attributes, productAttributes) {
            let attributeHtml = "";

            productAttributes
                .filter(pa => pa.product_id === productId)
                .forEach(pa => {
                    const attribute = attributes.find(attr => attr.id === pa.attribute_id);
                    if (attribute) {
                        attributeHtml += `<p>${attribute.name || "Unknown"}: ${pa.value}</p>`;
                    }
                });

            return attributeHtml || "<p>No attributes available</p>";
        }

        async function createProduct(event) {
            event.preventDefault(); // Prevent default form submission

            const productName = document.getElementById("productName").value;
            const productDescription = document.getElementById("productDescription").value;
            const productPrice = parseFloat(document.getElementById("productPrice").value);
            const productStock = parseInt(document.getElementById("productStock").value);

            const newProduct = {
                name: productName,
                description: productDescription,
                price: productPrice,
                stock_quantity: productStock
            };

            try {
                const response = await fetch(createProductUrl, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(newProduct)
                });

                if (response.ok) {
                    alert("Product created successfully!");
                    fetchProducts(); // Re-fetch products after adding a new one
                } else {
                    alert("Failed to create product.");
                }
            } catch (error) {
                console.error("Error creating product:", error);
            }
        }

        document.getElementById("createProductForm").addEventListener("submit", createProduct);

        async function uploadImage(event) {
            event.preventDefault(); // Prevent default form submission

            const formData = new FormData();
            formData.append("product_id", document.getElementById("product_id").value);
            formData.append("is_primary", document.getElementById("is_primary").value);
            formData.append("image", document.getElementById("image").files[0]);

            try {
                const response = await fetch(uploadImageUrl, {
                    method: "POST",
                    body: formData,
                });

                if (response.ok) {
                    const result = await response.json();
                    alert("Image uploaded successfully:\n" + JSON.stringify(result, null, 2));
                } else {
                    const error = await response.json();
                    alert("Error uploading image:\n" + error.error);
                }
            } catch (error) {
                alert("Failed to upload image:\n" + error.message);
            }
        }

        document.getElementById("uploadForm").addEventListener("submit", uploadImage);

        // Fetch and display products when the page loads
        fetchProducts();
    </script>
</body>
</html>
